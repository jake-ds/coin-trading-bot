# Ralph Progress Log — V4 Live-Ready Dashboard & Infrastructure
Started: 2026-02-22

## Codebase Patterns
- **Strategy pattern**: All strategies extend BaseStrategy ABC, register via strategy_registry.register()
- **Async-first**: All I/O uses async/await. Strategy analyze() is async.
- **Config**: pydantic-settings with .env + YAML override. New features disabled by default.
- **Testing**: pytest + pytest-asyncio. Always clean strategy_registry in fixtures.
- **Imports**: Always update __init__.py when adding new modules.
- **Dependencies**: Add to pyproject.toml AND requirements.txt.
- **Dashboard state**: Module-level dict in bot.dashboard.app. Test fixtures must reset all fields.
- **API endpoints**: V4 moves to /api/* prefix. /health stays at root for Docker healthcheck.
- **Frontend build**: npm run build outputs to src/bot/dashboard/static/. FastAPI serves as SPA.
- **Auth**: JWT via python-jose. Disabled when dashboard_password='changeme'.
- **Baseline**: 1494 tests passing on V3 branch (V2 + V3 complete).
- **API Router**: All API endpoints use `api_router = APIRouter(prefix="/api")`. Legacy HTML at `/legacy`.
- **Test URL prefix**: All test HTTP calls use `/api/` prefix (e.g., `/api/status`, `/api/trades`). `/health` stays at root.
- **SPA fallback**: `/{full_path:path}` catch-all serves index.html. Must be defined AFTER all API routes.
- **Frontend scaffold**: Vite + React 18 + TypeScript + Tailwind CSS 3 + react-router-dom v6.
- **Makefile**: `make frontend-install`, `make frontend-dev`, `make frontend-build`, `make test`, `make lint`.
- **WebSocket**: `ws_manager` singleton in `bot.dashboard.websocket`. Broadcast helpers in `bot.dashboard.app`. Rate-limited to 1/s via token-bucket debounce. `broadcast_immediate` for critical events.
- **WebSocket endpoint**: `/api/ws` registered directly on `app` (not via api_router). Sends full state payload on connect.
- **React hooks**: Custom hooks go in `frontend/src/hooks/`. `useWebSocket` provides `{ connected, data, lastUpdate }` with auto-reconnect.

---

## 2026-02-22 - V4-001
- Created frontend/ directory with Vite + React 18 + TypeScript + Tailwind CSS 3
- Files created:
  - frontend/package.json, tsconfig.json, tsconfig.node.json, vite.config.ts
  - frontend/tailwind.config.js, postcss.config.js, index.html
  - frontend/src/main.tsx, App.tsx, index.css, vite-env.d.ts
  - frontend/src/api/client.ts (axios with /api base + 401 interceptor)
  - frontend/src/api/types.ts (TypeScript types matching Python models)
  - frontend/src/pages/Dashboard.tsx, Trades.tsx, Strategies.tsx, Settings.tsx, Login.tsx
- Modified src/bot/dashboard/app.py:
  - Added APIRouter with `/api` prefix for all data endpoints
  - Moved HTML dashboard to `/legacy` route
  - Added SPA static file serving with index.html fallback
  - /health available at both root and /api/health
  - Added StaticFiles mount for built frontend assets
- Updated 5 test files for /api/ prefix:
  - tests/dashboard/test_app.py (all endpoint paths + dashboard HTML → /legacy)
  - tests/dashboard/test_v2_026_enhanced_dashboard.py (all paths + HTML → /legacy)
  - tests/test_v2_022_strategy_tracker.py (/strategies → /api/strategies)
  - tests/test_v3_integration.py (/quant/* → /api/quant/*)
  - tests/test_v2_007_cycle_safety.py (/status → /api/status)
- Created Makefile with frontend-install, frontend-dev, frontend-build, test, lint targets
- Updated .gitignore: added frontend/node_modules/, frontend/dist/, src/bot/dashboard/static/
- Tests: 1494 passing (all existing tests updated for /api/ prefix), ruff clean
- Frontend: npm run build succeeds (TypeScript + Vite)
- **Learnings for future iterations:**
  - APIRouter prefix means endpoint decorators use `/status` not `/api/status`
  - SPA catch-all route `/{full_path:path}` must be last to avoid catching API routes
  - /health stays at root for Docker healthcheck AND at /api/health for API consistency
  - Legacy dashboard at /legacy preserves backward compatibility for test assertions
  - Test count baseline: 1494 tests passing as of V4-001
---

## 2026-02-22 - V4-002
- Built Dashboard overview page with portfolio metrics, status, and regime display
- Files created:
  - frontend/src/components/common/StatusBadge.tsx (running/stopped badge with pulse animation)
  - frontend/src/components/common/MetricCard.tsx (reusable metric display card)
  - frontend/src/components/common/RegimeBadge.tsx (color-coded market regime badge)
  - frontend/src/components/common/PortfolioSummary.tsx (portfolio value + return display)
  - frontend/src/components/common/Skeleton.tsx (loading skeleton components)
- Files modified:
  - frontend/src/pages/Dashboard.tsx (full implementation with data fetching)
- Features:
  - Fetches /api/status, /api/portfolio, /api/metrics, /api/regime on mount via Promise.allSettled
  - Auto-refresh every 10 seconds via useEffect interval
  - Loading skeleton states (PortfolioSummarySkeleton, MetricCardSkeleton)
  - Error state with styled error message
  - Responsive grid: 1 col mobile, 2 cols tablet, 3 cols desktop
  - Dark theme by default (bg-gray-800/900 cards, gray-700 borders)
  - Color-coded metrics: green=positive, red=negative, amber=warning
  - Regime badge colors: green=trending up, red=trending down, amber=ranging, purple=volatile
  - Cycle info panel: cycle count, avg duration, last cycle time
- Tests: 1494 passing (no Python changes), ruff clean, frontend builds clean
- **Learnings for future iterations:**
  - Promise.allSettled is better than Promise.all for dashboard — partial data is better than no data
  - Components in frontend/src/components/common/ for reuse across pages
  - No Python backend changes needed — all endpoints already existed from V3
---

## 2026-02-22 - V4-003
- Added WebSocket real-time updates replacing polling for dashboard
- Files created:
  - src/bot/dashboard/websocket.py (ConnectionManager with rate-limited broadcast + immediate broadcast)
  - frontend/src/hooks/useWebSocket.ts (auto-reconnect with exponential backoff, max 30s)
  - frontend/src/components/common/ConnectionIndicator.tsx (green/red dot + Live/Offline label)
  - tests/dashboard/test_websocket.py (22 tests)
- Files modified:
  - src/bot/dashboard/app.py:
    - Added /api/ws WebSocket endpoint (registered directly on app, not api_router)
    - Sends full state payload on client connect
    - Added broadcast helpers: broadcast_state_update, broadcast_trade, broadcast_position_change, broadcast_alert
    - Strategy toggle now triggers WebSocket broadcast
  - src/bot/main.py:
    - Imported broadcast_state_update and broadcast_trade
    - Added broadcast_state_update() at end of _trading_cycle
    - Added broadcast_trade() for each trade in recent_trades
  - frontend/src/App.tsx:
    - Added ConnectionIndicator next to "Trading Bot" title in header
    - Added useWebSocket hook for connection status
  - frontend/src/pages/Dashboard.tsx:
    - Switched from pure polling to WebSocket with polling fallback
    - Applies status_update messages from WS to dashboard state
    - Falls back to 10s polling when WS disconnects
  - frontend/src/api/types.ts:
    - Added WsStatusPayload interface for WebSocket message typing
- Features:
  - WebSocket message format: { type: 'status_update'|'trade'|'position_change'|'alert', payload: {...} }
  - Rate limiting: broadcasts debounced to max 1/second (broadcast_immediate bypasses for critical events)
  - Auto-reconnect: exponential backoff from 1s to max 30s
  - Connection indicator: green dot + "Live" when connected, red dot + "Offline" when disconnected
  - Fallback: Dashboard automatically switches to 10s polling when WebSocket disconnects
- Tests: 1516 passing (1494 existing + 22 new), ruff clean, frontend builds clean
- **Learnings for future iterations:**
  - WebSocket endpoint must be on `app` directly (not `api_router`) since FastAPI WS decorators use `@app.websocket()`
  - starlette.testclient.TestClient is needed for sync WS testing; httpx AsyncClient doesn't support WS
  - Rate limiting via debounce task (asyncio.ensure_future with delay) is simpler than token bucket for broadcast use case
  - Test fixtures must clear ws_manager._connections to prevent cross-test interference
  - Test count baseline: 1516 tests passing as of V4-003
---

## 2026-02-22 - V4-004
- Built Trades and Positions pages with live updates via WebSocket
- Files created:
  - frontend/src/pages/Positions.tsx (open positions table with PnL, SL/TP, duration)
  - frontend/src/pages/Trades.tsx (full trade history with pagination, sorting, CSV export)
  - frontend/src/components/common/Toast.tsx (toast notification with auto-dismiss and animation)
  - tests/dashboard/test_v4_004_trades_positions.py (17 tests)
- Files modified:
  - src/bot/dashboard/app.py:
    - Added pagination to /api/trades (page, limit, symbol query params, newest-first ordering)
    - Added /api/positions endpoint (alias for open_positions data)
    - Added Query import from FastAPI
  - frontend/src/api/types.ts:
    - Added Position interface, PositionsResponse interface
    - Updated TradesResponse with pagination fields (total, page, limit, total_pages)
    - Added optional pnl and strategy fields to Trade interface
    - Typed open_positions as Position[] in WsStatusPayload
  - frontend/src/App.tsx:
    - Added Positions nav item and route
    - Added Toast component with trade event notifications from WebSocket
    - Toast shows BUY/SELL with symbol and price on 'trade' WS events
- Features:
  - Positions page: table with symbol, qty, entry/current price, color-coded unrealized PnL (with % and absolute), SL, TP, duration held
  - Trades page: sortable table (click column headers), pagination with 20/page, symbol filter, CSV export
  - Toast notifications: popup on new trade events, auto-dismiss after 5s, slide-in animation
  - Both pages update in real-time via WebSocket (status_update and trade events)
  - Empty state messages when no positions/trades
  - Responsive dark theme matching existing design
- Tests: 1533 passing (1516 existing + 17 new), ruff clean, frontend builds clean
- **Learnings for future iterations:**
  - Adding new query params to existing endpoints with defaults preserves backward compatibility
  - The /api/positions endpoint is a cleaner alias for /api/open-positions (both remain)
  - WebSocket trade events trigger page refresh from server for pagination consistency
  - Test count baseline: 1533 tests passing as of V4-004
---
